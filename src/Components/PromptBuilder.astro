---
// Configuración de categorías de filtros (mock)
const filterGroups = [
  {
    id: 'artType',
    label: 'Art Type',
    options: ['Fotografía', 'Render 3D', 'Arte Digital', 'Acuarela', 'Anime', 'Minimalist Art']
  },
  {
    id: 'photoStyle',
    label: 'Photo Style',
    options: ['Retrato', 'Street Photography', 'Paisaje', 'Fotografía de Producto', 'Cinematic Photography', 'Minimalist Photography']
  },
  {
    id: 'lighting',
    label: 'Lighting / Technique',
    options: ['Golden Hour', 'Natural Light', 'Studio Light', 'Long Exposure', 'HDR', 'Volumetric Lighting']
  },
  {
    id: 'mood',
    label: 'Mood / Aesthetic',
    options: ['Cinematic', 'Dreamy', 'Dark', 'Bright', 'Vintage', 'Cyberpunk Mood']
  }
];

// Datos mock de productos para demostrar filtrado
const mockProducts = [
  {
    id: 1,
    name: 'Portrait Neon Editorial',
    subject: 'Modelo urbana en calle nocturna',
    tags: {
      artType: ['Fotografía'],
      photoStyle: ['Retrato', 'Cinematic Photography'],
      lighting: ['Studio Light', 'HDR'],
      mood: ['Cinematic', 'Cyberpunk Mood']
    }
  },
  {
    id: 2,
    name: 'Bosque Etéreo',
    subject: 'Paisaje mágico al amanecer',
    tags: {
      artType: ['Acuarela', 'Minimalist Art'],
      photoStyle: ['Paisaje'],
      lighting: ['Golden Hour', 'Natural Light'],
      mood: ['Dreamy', 'Bright']
    }
  },
  {
    id: 3,
    name: 'Producto Premium Studio',
    subject: 'Reloj de lujo sobre fondo negro',
    tags: {
      artType: ['Arte Digital'],
      photoStyle: ['Fotografía de Producto'],
      lighting: ['Studio Light', 'Volumetric Lighting'],
      mood: ['Dark', 'Vintage']
    }
  },
  {
    id: 4,
    name: 'Tokyo Motion Shot',
    subject: 'Cruce urbano con lluvia',
    tags: {
      artType: ['Render 3D'],
      photoStyle: ['Street Photography'],
      lighting: ['Long Exposure', 'HDR'],
      mood: ['Cinematic', 'Dark']
    }
  }
];
---

<section class="relative mx-auto mt-8 max-w-7xl px-4 pb-10 sm:px-6 lg:px-8">
  <div class="grid grid-cols-1 gap-6 lg:grid-cols-[260px_minmax(0,1fr)]">
    <aside id="historyPanel" class="hidden rounded-2xl border border-slate-200 bg-white shadow-sm lg:block" aria-label="Historial de prompts">
      <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3">
        <h3 class="text-sm font-semibold text-slate-700">Historial</h3>
        <button id="clearHistoryBtn" type="button" class="text-xs font-medium text-indigo-600 hover:text-indigo-700">Limpiar</button>
      </div>
      <div id="historyList" class="max-h-[70vh] space-y-2 overflow-y-auto p-3 text-sm"></div>
    </aside>

    <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 shadow-sm sm:p-6">
      <header class="mb-6 flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-2xl font-bold text-slate-900">Prompt Builder</h2>
          <p class="text-sm text-slate-600">Seleccioná múltiples filtros para construir prompts más precisos.</p>
        </div>
        <button
          id="openFiltersMobile"
          type="button"
          class="inline-flex items-center rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:border-indigo-400 hover:text-indigo-600 lg:hidden"
          aria-controls="mobileFiltersDialog"
          aria-expanded="false"
        >
          Filtros
        </button>
      </header>

      <div class="grid grid-cols-1 gap-6 lg:grid-cols-[320px_minmax(0,1fr)]">
        <aside class="hidden h-fit rounded-2xl border border-slate-200 bg-white p-4 lg:block" aria-label="Filtros">
          <div class="mb-3 flex items-center justify-between">
            <h3 class="text-sm font-semibold text-slate-700">Filtros</h3>
            <span id="activeCountDesktop" class="rounded-full bg-indigo-50 px-2 py-1 text-xs font-semibold text-indigo-700">0 activos</span>
          </div>
          <div id="filtersDesktop" class="space-y-3"></div>
          <button id="applyFiltersDesktop" type="button" class="mt-4 w-full rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700">Aplicar filtros</button>
        </aside>

        <div class="space-y-5">
          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <label for="subjectInput" class="mb-2 block text-xs font-semibold uppercase tracking-wide text-slate-500">Sujeto</label>
            <input id="subjectInput" type="text" class="w-full rounded-xl border border-slate-300 px-4 py-3 text-sm text-slate-700 outline-none ring-indigo-500 focus:ring-2" placeholder="Ej: astronauta caminando en Marte" />
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="mb-3 flex flex-wrap items-center justify-between gap-2">
              <h3 class="text-sm font-semibold text-slate-700">Filtros activos</h3>
              <button id="clearAllFilters" type="button" class="text-sm font-medium text-indigo-600 hover:text-indigo-700">Limpiar todo</button>
            </div>
            <div id="activeFiltersChips" class="flex min-h-8 flex-wrap gap-2"></div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="mb-3 flex items-center justify-between">
              <h3 class="text-sm font-semibold text-slate-700">Resultados (<span id="resultsCount">0</span>)</h3>
            </div>
            <ul id="resultsList" class="space-y-3"></ul>
          </div>

          <div class="relative rounded-xl bg-indigo-900 p-4 text-white">
            <p class="mb-1 text-xs font-semibold uppercase tracking-wider text-indigo-200">Prompt generado</p>
            <p id="resultPrompt" class="min-h-8 pr-24 text-sm italic text-indigo-50">Completá el sujeto y aplicá filtros.</p>
            <button id="copyPromptBtn" type="button" class="absolute bottom-4 right-4 hidden rounded-lg bg-indigo-500 px-3 py-1 text-xs font-semibold hover:bg-indigo-400">Copiar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="mobileFiltersDialog" class="fixed inset-0 z-50 hidden bg-slate-900/45 p-4 lg:hidden" role="dialog" aria-modal="true" aria-labelledby="mobileFiltersTitle">
    <div class="mx-auto mt-8 max-w-md rounded-2xl bg-white p-4 shadow-2xl">
      <div class="mb-3 flex items-center justify-between">
        <h3 id="mobileFiltersTitle" class="text-sm font-semibold text-slate-700">Filtros</h3>
        <button id="closeFiltersMobile" type="button" class="rounded-lg border border-slate-300 px-2 py-1 text-sm">Cerrar</button>
      </div>
      <div class="mb-3 flex items-center justify-between">
        <span id="activeCountMobile" class="rounded-full bg-indigo-50 px-2 py-1 text-xs font-semibold text-indigo-700">0 activos</span>
      </div>
      <div id="filtersMobile" class="max-h-[55vh] space-y-3 overflow-y-auto"></div>
      <button id="applyFiltersMobile" type="button" class="mt-4 w-full rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white">Aplicar filtros</button>
    </div>
  </div>
</section>

<script define:vars={{ filterGroups, mockProducts }}>
  /**
   * Estado principal del componente
   */
  const STORAGE_FILTERS_KEY = 'promptBuilderFilters';
  const STORAGE_HISTORY_KEY = 'promptBuilderHistory';

  const state = {
    subject: '',
    selectedFilters: Object.fromEntries(filterGroups.map((group) => [group.id, []])),
    filteredProducts: [...mockProducts]
  };

  const refs = {
    desktopContainer: document.getElementById('filtersDesktop'),
    mobileContainer: document.getElementById('filtersMobile'),
    activeCountDesktop: document.getElementById('activeCountDesktop'),
    activeCountMobile: document.getElementById('activeCountMobile'),
    chips: document.getElementById('activeFiltersChips'),
    resultsList: document.getElementById('resultsList'),
    resultsCount: document.getElementById('resultsCount'),
    resultPrompt: document.getElementById('resultPrompt'),
    copyPromptBtn: document.getElementById('copyPromptBtn'),
    subjectInput: document.getElementById('subjectInput'),
    historyList: document.getElementById('historyList')
  };

  /**
   * Renderiza acordeones de filtros (desktop + mobile)
   */
  function renderFilterGroups(container, suffix) {
    container.innerHTML = filterGroups
      .map(
        (group, groupIndex) => `
          <section class="rounded-xl border border-slate-200" data-group="${group.id}">
            <button
              type="button"
              class="accordion-toggle flex w-full items-center justify-between px-3 py-2 text-left text-sm font-semibold text-slate-700"
              aria-expanded="${groupIndex === 0 ? 'true' : 'false'}"
              aria-controls="panel-${group.id}-${suffix}"
            >
              <span>${group.label}</span>
              <span aria-hidden="true">▾</span>
            </button>
            <div id="panel-${group.id}-${suffix}" class="accordion-panel overflow-hidden px-3 transition-all duration-300 ease-out" style="max-height: ${groupIndex === 0 ? '480px' : '0px'}">
              <fieldset class="space-y-2 pb-3" aria-label="${group.label}">
                ${group.options
                  .map(
                    (option, optionIndex) => `
                    <label class="flex cursor-pointer items-center gap-2 rounded-lg p-1 text-sm text-slate-600 hover:bg-slate-50" for="${group.id}-${suffix}-${optionIndex}">
                      <input
                        id="${group.id}-${suffix}-${optionIndex}"
                        class="filter-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                        type="checkbox"
                        data-group-id="${group.id}"
                        data-option="${option}"
                      />
                      <span>${option}</span>
                    </label>
                  `
                  )
                  .join('')}
              </fieldset>
            </div>
          </section>
        `
      )
      .join('');
  }

  function setupAccordionHandlers(container) {
    container.querySelectorAll('.accordion-toggle').forEach((button) => {
      button.addEventListener('click', () => {
        const panelId = button.getAttribute('aria-controls');
        const panel = document.getElementById(panelId);
        const isOpen = button.getAttribute('aria-expanded') === 'true';

        button.setAttribute('aria-expanded', String(!isOpen));
        panel.style.maxHeight = isOpen ? '0px' : `${panel.scrollHeight}px`;
      });
    });
  }

  function setupCheckboxHandlers(container) {
    container.querySelectorAll('.filter-checkbox').forEach((checkbox) => {
      checkbox.addEventListener('change', (event) => {
        const target = event.currentTarget;
        const groupId = target.dataset.groupId;
        const option = target.dataset.option;

        if (target.checked) {
          state.selectedFilters[groupId] = [...new Set([...state.selectedFilters[groupId], option])];
        } else {
          state.selectedFilters[groupId] = state.selectedFilters[groupId].filter((item) => item !== option);
        }

        syncCheckboxes(groupId, option, target.checked);
        updateActiveUI();
        persistFilters();
      });
    });
  }

  function syncCheckboxes(groupId, option, checked) {
    document.querySelectorAll(`.filter-checkbox[data-group-id="${groupId}"][data-option="${option}"]`).forEach((input) => {
      input.checked = checked;
    });
  }

  function hydrateSelectionsInDOM() {
    Object.entries(state.selectedFilters).forEach(([groupId, options]) => {
      options.forEach((option) => syncCheckboxes(groupId, option, true));
    });
  }

  function totalActiveFilters() {
    return Object.values(state.selectedFilters).reduce((acc, groupSelection) => acc + groupSelection.length, 0);
  }

  function updateActiveUI() {
    const total = totalActiveFilters();
    refs.activeCountDesktop.textContent = `${total} activos`;
    refs.activeCountMobile.textContent = `${total} activos`;

    refs.chips.innerHTML = Object.entries(state.selectedFilters)
      .flatMap(([groupId, options]) => options.map((option) => ({ groupId, option })))
      .map(
        ({ groupId, option }) => `
          <button type="button" class="rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700" data-remove-group="${groupId}" data-remove-option="${option}">
            ${option} ✕
          </button>
        `
      )
      .join('');

    if (!refs.chips.innerHTML.trim()) {
      refs.chips.innerHTML = '<p class="text-sm text-slate-400">No hay filtros activos.</p>';
    }

    refs.chips.querySelectorAll('button[data-remove-group]').forEach((button) => {
      button.addEventListener('click', () => {
        const groupId = button.dataset.removeGroup;
        const option = button.dataset.removeOption;
        state.selectedFilters[groupId] = state.selectedFilters[groupId].filter((item) => item !== option);
        syncCheckboxes(groupId, option, false);
        updateActiveUI();
        persistFilters();
      });
    });
  }

  /**
   * Ejemplo real de aplicación de filtros sobre un array de productos mock.
   */
  function applyFiltersToProducts() {
    const hasActiveFilters = totalActiveFilters() > 0;

    state.filteredProducts = mockProducts.filter((product) => {
      if (!hasActiveFilters) return true;

      return Object.entries(state.selectedFilters).every(([groupId, selectedOptions]) => {
        if (!selectedOptions.length) return true;
        return selectedOptions.some((selectedOption) => product.tags[groupId]?.includes(selectedOption));
      });
    });

    renderProducts();
    generatePrompt();
  }

  function renderProducts() {
    refs.resultsCount.textContent = String(state.filteredProducts.length);

    refs.resultsList.innerHTML = state.filteredProducts
      .map(
        (product) => `
          <li class="rounded-xl border border-slate-200 p-3">
            <p class="font-semibold text-slate-800">${product.name}</p>
            <p class="text-sm text-slate-600">${product.subject}</p>
          </li>
        `
      )
      .join('');

    if (!state.filteredProducts.length) {
      refs.resultsList.innerHTML = '<li class="text-sm text-slate-500">Sin resultados para la combinación elegida.</li>';
    }
  }

  function generatePrompt() {
    const groupedTokens = Object.entries(state.selectedFilters)
      .filter(([, options]) => options.length)
      .map(([groupId, options]) => `${groupId}: ${options.join(', ')}`);

    const subject = state.subject.trim();
    const promptParts = [subject ? `subject: ${subject}` : '', ...groupedTokens].filter(Boolean);
    const prompt = promptParts.join(' | ');

    refs.resultPrompt.textContent = prompt || 'Completá el sujeto y aplicá filtros.';
    refs.copyPromptBtn.classList.toggle('hidden', !prompt);

    if (prompt) {
      savePromptToHistory(prompt);
      renderHistory();
    }
  }

  function persistFilters() {
    localStorage.setItem(STORAGE_FILTERS_KEY, JSON.stringify(state.selectedFilters));
  }

  function restoreFilters() {
    const saved = localStorage.getItem(STORAGE_FILTERS_KEY);
    if (!saved) return;

    try {
      const parsed = JSON.parse(saved);
      filterGroups.forEach((group) => {
        if (Array.isArray(parsed[group.id])) {
          state.selectedFilters[group.id] = parsed[group.id];
        }
      });
    } catch (error) {
      localStorage.removeItem(STORAGE_FILTERS_KEY);
    }
  }

  function savePromptToHistory(prompt) {
    const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY_KEY) || '[]');
    const nextHistory = [
      { text: prompt, createdAt: new Date().toISOString() },
      ...history.filter((entry) => entry.text !== prompt)
    ].slice(0, 30);

    localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(nextHistory));
  }

  function renderHistory() {
    const history = JSON.parse(localStorage.getItem(STORAGE_HISTORY_KEY) || '[]');
    refs.historyList.innerHTML = history
      .map(
        (item) => `
          <button type="button" class="w-full rounded-lg border border-transparent px-3 py-2 text-left text-xs text-slate-600 hover:border-slate-200 hover:bg-slate-50" data-history-text="${item.text.replaceAll('"', '&quot;')}">
            ${item.text}
          </button>
        `
      )
      .join('');

    refs.historyList.querySelectorAll('[data-history-text]').forEach((button) => {
      button.addEventListener('click', () => {
        refs.resultPrompt.textContent = button.dataset.historyText;
        refs.copyPromptBtn.classList.remove('hidden');
      });
    });
  }

  function clearAllFilters() {
    state.selectedFilters = Object.fromEntries(filterGroups.map((group) => [group.id, []]));
    document.querySelectorAll('.filter-checkbox').forEach((input) => {
      input.checked = false;
    });
    updateActiveUI();
    applyFiltersToProducts();
    persistFilters();
  }

  function setupModalControls() {
    const modal = document.getElementById('mobileFiltersDialog');
    const openBtn = document.getElementById('openFiltersMobile');
    const closeBtn = document.getElementById('closeFiltersMobile');

    const closeModal = () => {
      modal.classList.add('hidden');
      openBtn.setAttribute('aria-expanded', 'false');
      openBtn.focus();
    };

    openBtn.addEventListener('click', () => {
      modal.classList.remove('hidden');
      openBtn.setAttribute('aria-expanded', 'true');
      closeBtn.focus();
    });

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
      if (event.target === modal) closeModal();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    document.getElementById('applyFiltersMobile').addEventListener('click', () => {
      applyFiltersToProducts();
      closeModal();
    });
  }

  function bindEvents() {
    document.getElementById('applyFiltersDesktop').addEventListener('click', applyFiltersToProducts);
    document.getElementById('clearAllFilters').addEventListener('click', clearAllFilters);
    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_HISTORY_KEY);
      renderHistory();
    });

    refs.subjectInput.addEventListener('input', (event) => {
      state.subject = event.target.value;
    });

    refs.copyPromptBtn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(refs.resultPrompt.textContent);
      refs.copyPromptBtn.textContent = '¡Copiado!';
      setTimeout(() => {
        refs.copyPromptBtn.textContent = 'Copiar';
      }, 1200);
    });
  }

  function init() {
    renderFilterGroups(refs.desktopContainer, 'desktop');
    renderFilterGroups(refs.mobileContainer, 'mobile');

    setupAccordionHandlers(refs.desktopContainer);
    setupAccordionHandlers(refs.mobileContainer);
    setupCheckboxHandlers(refs.desktopContainer);
    setupCheckboxHandlers(refs.mobileContainer);

    restoreFilters();
    hydrateSelectionsInDOM();
    updateActiveUI();
    renderHistory();
    renderProducts();

    setupModalControls();
    bindEvents();
  }

  init();
</script>
